'use strict';

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

var _require = require('path');

const extname = _require.extname,
      resolve = _require.resolve;

var _require2 = require('qs');

const stringify = _require2.stringify;

const Boom = require('boom');
const s = require('underscore.string');

var _require3 = require('lodash');

const isEmpty = _require3.isEmpty,
      sortBy = _require3.sortBy,
      every = _require3.every,
      isFunction = _require3.isFunction;

var _require4 = require('country-language');

const getLanguage = _require4.getLanguage;

const moment = require('moment');
const i18n = require('i18n');
const locales = require('i18n-locales');
const autoBind = require('auto-bind');
const debug = require('debug')('ladjs:i18n');
const boolean = require('boolean');

// expose global
i18n.api = {};

class I18N {
  constructor(config = {}) {
    this.config = Object.assign({
      phrases: {},
      logger: console,
      directory: resolve('locales'),
      locales: ['en', 'es', 'zh'],
      cookie: 'locale',
      indent: '  ',
      defaultLocale: 'en',
      syncFiles: boolean(process.env.I18N_SYNC_FILES || true),
      autoReload: boolean(process.env.I18N_AUTO_RELOAD || false),
      updateFiles: boolean(process.env.I18N_UPDATE_FILES || true),
      api: {
        __: 't',
        __n: 'tn',
        __l: 'tl',
        __h: 'th',
        __mf: 'tmf'
      },
      register: i18n.api
    }, config);

    const logger = this.config.logger;


    this.config.logDebugFn = logger.debug;
    this.config.logWarnFn = logger.warn;
    this.config.logErrorFn = logger.error;

    // validate locales against available ones
    if (!every(this.config.locales, l => locales.includes(l))) throw new Error(`Invalid locales: ${this.config.locales.filter(str => !locales.includes(str)).join(', ')}`);

    // inherit i18n object
    Object.assign(this, i18n);

    // configure i18n
    this.configure(this.config);

    autoBind(this);
  }

  translate(key, locale) {
    var _config = this.config;
    const logger = _config.logger,
          phrases = _config.phrases;
    // eslint-disable-next-line prefer-rest-params

    let args = Object.keys(arguments)
    // eslint-disable-next-line prefer-rest-params
    .map(key => arguments[key]).slice(2);
    if (typeof args === 'undefined') args = [];
    const phrase = phrases[key];
    if (typeof phrase !== 'string') {
      logger.warn(`translation key missing: ${key}`);
      return;
    }
    args = [{ phrase, locale }, ...args];
    return i18n.api.t(...args);
  }

  middleware(ctx, next) {
    var _config2 = this.config;
    const locales = _config2.locales,
          defaultLocale = _config2.defaultLocale,
          phrases = _config2.phrases,
          cookie = _config2.cookie;

    // expose api methods to `ctx.req` and `ctx.state`

    i18n.init(ctx.req, ctx.state);

    // expose a helper function to `ctx.state.l`
    // which prefixes a link/path with the locale
    ctx.state.l = (path = '') => {
      return `/${ctx.state.locale}${path}`;
    };

    // override the existing locale detection with our own
    // in order of priority:
    //
    // 1. check the URL, if === `/de` or starts with `/de/` then locale is `de`
    // 2. check the cookie
    // 3. check Accept-Language last
    //
    // also we need to expose `ctx.pathWithoutLocale`
    // as the path without locale

    let locale = locales.find(l => {
      return `/${l}` === ctx.path || ctx.path.indexOf(`/${l}/`) === 0;
    });

    ctx.pathWithoutLocale = locale ? ctx.path.substring(`/${locale}`.length) : ctx.path;
    if (ctx.pathWithoutLocale === '') ctx.pathWithoutLocale = '/';

    if (!locale) {
      locale = defaultLocale;
      if (ctx.cookies.get(cookie) && locales.includes(ctx.cookies.get(cookie))) {
        locale = ctx.cookies.get(cookie);
        debug('found locale via cookie using %s', locale);
      } else if (ctx.request.acceptsLanguages(locales)) {
        locale = ctx.request.acceptsLanguages(locales);
        debug('found locale via Accept-Language header using %s', locale);
      } else {
        debug('using default locale');
      }
    }

    // set the locale properly
    i18n.setLocale([ctx.req, ctx.state], locale);
    ctx.locale = ctx.req.locale;

    // if the locale was not available then redirect user
    if (locale !== ctx.state.locale) {
      debug('locale was not available redirecting user');
      return ctx.redirect(`/${ctx.state.locale}${ctx.pathWithoutLocale}${isEmpty(ctx.query) ? '' : `?${stringify(ctx.query)}`}`);
    }

    // available languages for a dropdown menu to change language
    ctx.state.availableLanguages = sortBy(locales.map(locale => {
      return {
        locale,
        url: `/${locale}${ctx.pathWithoutLocale}${isEmpty(ctx.query) ? '' : `?${stringify(ctx.query)}`}`,
        name: getLanguage(locale).name[0]
      };
    }), 'name');

    // get the name of the current locale's language in native language
    ctx.state.currentLanguage = s.titleize(getLanguage(ctx.req.locale).nativeName[0]);

    // bind `ctx.translate` as a helper func
    // so you can pass `ctx.translate('SOME_KEY_IN_CONFIG');` and it will lookup
    // `phrases['SOMETHING']` to get a specific and constant message
    // and then it will call `t` to translate it to the user's locale
    ctx.translate = function (...args) {
      if (typeof args[0] !== 'string' || typeof phrases[args[0]] !== 'string') return ctx.throw(Boom.badRequest('Translation for your locale failed, try again'));
      args[0] = phrases[args[0]];
      return ctx.req.t(...args);
    };

    return next();
  }

  redirect(ctx, next) {
    var _this = this;

    return _asyncToGenerator(function* () {
      debug('attempting to redirect');
      // do not redirect static paths
      if (extname(ctx.path) !== '') return next();

      // inspired by nodejs.org language support
      // <https://github.com/nodejs/nodejs.org/commit/d6cdd942a8fc0fffcf6879eca124295e95991bbc#diff-78c12f5adc1848d13b1c6f07055d996eR59>
      const locale = ctx.url.split('/')[1].split('?')[0];
      const hasLang = _this.config.locales.includes(locale);

      // if the URL did not have a valid language found
      // then redirect the user to their detected locale
      if (!hasLang) {
        ctx.status = 302;
        let redirect = `/${ctx.req.locale}${ctx.url}`;
        if (!isEmpty(ctx.query)) redirect += `?${stringify(ctx.query)}`;
        debug('no valid locale found in URL, redirecting to %s', redirect);
        return ctx.redirect(redirect);
      }

      debug('found valid language "%s"', locale);

      // set the cookie for future requests
      ctx.cookies.set(_this.config.cookie, locale, {
        // Disable signed cookies in NODE_ENV=test
        signed: process.env.NODE_ENV !== 'test',
        expires: moment().add(1, 'year').toDate()
      });
      debug('set cookies for locale "%s"', locale);

      // if the user is logged in and ctx.isAuthenticated() exists,
      // then save it as `last_locale`
      if (isFunction(ctx.isAuthenticated) && ctx.isAuthenticated()) {
        ctx.state.user.last_locale = locale;
        try {
          yield ctx.state.user.save();
        } catch (err) {
          _this.config.logger.error(err);
        }
      }

      return next();
    })();
  }
}

module.exports = I18N;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiZXh0bmFtZSIsInJlc29sdmUiLCJzdHJpbmdpZnkiLCJCb29tIiwicyIsImlzRW1wdHkiLCJzb3J0QnkiLCJldmVyeSIsImlzRnVuY3Rpb24iLCJnZXRMYW5ndWFnZSIsIm1vbWVudCIsImkxOG4iLCJsb2NhbGVzIiwiYXV0b0JpbmQiLCJkZWJ1ZyIsImJvb2xlYW4iLCJhcGkiLCJJMThOIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJPYmplY3QiLCJhc3NpZ24iLCJwaHJhc2VzIiwibG9nZ2VyIiwiY29uc29sZSIsImRpcmVjdG9yeSIsImNvb2tpZSIsImluZGVudCIsImRlZmF1bHRMb2NhbGUiLCJzeW5jRmlsZXMiLCJwcm9jZXNzIiwiZW52IiwiSTE4Tl9TWU5DX0ZJTEVTIiwiYXV0b1JlbG9hZCIsIkkxOE5fQVVUT19SRUxPQUQiLCJ1cGRhdGVGaWxlcyIsIkkxOE5fVVBEQVRFX0ZJTEVTIiwiX18iLCJfX24iLCJfX2wiLCJfX2giLCJfX21mIiwicmVnaXN0ZXIiLCJsb2dEZWJ1Z0ZuIiwibG9nV2FybkZuIiwid2FybiIsImxvZ0Vycm9yRm4iLCJlcnJvciIsImwiLCJpbmNsdWRlcyIsIkVycm9yIiwiZmlsdGVyIiwic3RyIiwiam9pbiIsImNvbmZpZ3VyZSIsInRyYW5zbGF0ZSIsImtleSIsImxvY2FsZSIsImFyZ3MiLCJrZXlzIiwiYXJndW1lbnRzIiwibWFwIiwic2xpY2UiLCJwaHJhc2UiLCJ0IiwibWlkZGxld2FyZSIsImN0eCIsIm5leHQiLCJpbml0IiwicmVxIiwic3RhdGUiLCJwYXRoIiwiZmluZCIsImluZGV4T2YiLCJwYXRoV2l0aG91dExvY2FsZSIsInN1YnN0cmluZyIsImxlbmd0aCIsImNvb2tpZXMiLCJnZXQiLCJyZXF1ZXN0IiwiYWNjZXB0c0xhbmd1YWdlcyIsInNldExvY2FsZSIsInJlZGlyZWN0IiwicXVlcnkiLCJhdmFpbGFibGVMYW5ndWFnZXMiLCJ1cmwiLCJuYW1lIiwiY3VycmVudExhbmd1YWdlIiwidGl0bGVpemUiLCJuYXRpdmVOYW1lIiwidGhyb3ciLCJiYWRSZXF1ZXN0Iiwic3BsaXQiLCJoYXNMYW5nIiwic3RhdHVzIiwic2V0Iiwic2lnbmVkIiwiTk9ERV9FTlYiLCJleHBpcmVzIiwiYWRkIiwidG9EYXRlIiwiaXNBdXRoZW50aWNhdGVkIiwidXNlciIsImxhc3RfbG9jYWxlIiwic2F2ZSIsImVyciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7ZUFBNkJBLFFBQVEsTUFBUixDOztNQUFyQkMsTyxZQUFBQSxPO01BQVNDLE8sWUFBQUEsTzs7Z0JBQ0tGLFFBQVEsSUFBUixDOztNQUFkRyxTLGFBQUFBLFM7O0FBQ1IsTUFBTUMsT0FBT0osUUFBUSxNQUFSLENBQWI7QUFDQSxNQUFNSyxJQUFJTCxRQUFRLG1CQUFSLENBQVY7O2dCQUMrQ0EsUUFBUSxRQUFSLEM7O01BQXZDTSxPLGFBQUFBLE87TUFBU0MsTSxhQUFBQSxNO01BQVFDLEssYUFBQUEsSztNQUFPQyxVLGFBQUFBLFU7O2dCQUNSVCxRQUFRLGtCQUFSLEM7O01BQWhCVSxXLGFBQUFBLFc7O0FBQ1IsTUFBTUMsU0FBU1gsUUFBUSxRQUFSLENBQWY7QUFDQSxNQUFNWSxPQUFPWixRQUFRLE1BQVIsQ0FBYjtBQUNBLE1BQU1hLFVBQVViLFFBQVEsY0FBUixDQUFoQjtBQUNBLE1BQU1jLFdBQVdkLFFBQVEsV0FBUixDQUFqQjtBQUNBLE1BQU1lLFFBQVFmLFFBQVEsT0FBUixFQUFpQixZQUFqQixDQUFkO0FBQ0EsTUFBTWdCLFVBQVVoQixRQUFRLFNBQVIsQ0FBaEI7O0FBRUE7QUFDQVksS0FBS0ssR0FBTCxHQUFXLEVBQVg7O0FBRUEsTUFBTUMsSUFBTixDQUFXO0FBQ1RDLGNBQVlDLFNBQVMsRUFBckIsRUFBeUI7QUFDdkIsU0FBS0EsTUFBTCxHQUFjQyxPQUFPQyxNQUFQLENBQ1o7QUFDRUMsZUFBUyxFQURYO0FBRUVDLGNBQVFDLE9BRlY7QUFHRUMsaUJBQVd4QixR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aUIsS0FBZCxDQUFxQixFQUFyQztBQUN6QnJFLGNBQU0saURBQU4sRUFBeURvRSxRQUF6RDtBQUNBLGVBQU9oQixJQUFJZ0IsUUFBSixDQUFhQSxRQUFiLENBQVA7QUFDRDs7QUFFRHBFLFlBQU0sMkJBQU4sRUFBbUMyQyxNQUFuQzs7QUFFQTtBQUNBUyxVQUFJVyxPQUFKLENBQVlrQixHQUFaLENBQWdCLE1BQUs1RSxNQUFMLENBQVlPLE1BQTVCLEVBQW9DK0IsTUFBcEMsRUFBNEM7QUFDMUM7QUFDQXVDLGdCQUFRbEUsUUFBUUMsR0FBUixDQUFZa0UsUUFBWixLQUF5QixNQUZTO0FBRzFDQyxpQkFBU3hGLFNBQ055RixHQURNLENBQ0YsQ0FERSxFQUNDLE1BREQsRUFFTkMsTUFGTTtBQUhpQyxPQUE1QztBQU9BdEYsWUFBTSw2QkFBTixFQUFxQzJDLE1BQXJDOztBQUVBO0FBQ0E7QUFDQSxVQUFJakQsV0FBVzBELElBQUltQyxlQUFmLEtBQW1DbkMsSUFBSW1DLGVBQUosRUFBdkMsRUFBOEQ7QUFDNURuQyxZQUFJSSxLQUFKLENBQVVnQyxJQUFWLENBQWVDLFdBQWYsR0FBNkI5QyxNQUE3QjtBQUNBLFlBQUk7QUFDRixnQkFBTVMsSUFBSUksS0FBSixDQUFVZ0MsSUFBVixDQUFlRSxJQUFmLEVBQU47QUFDRCxTQUZELENBRUUsT0FBT0MsR0FBUCxFQUFZO0FBQ1osZ0JBQUt0RixNQUFMLENBQVlJLE1BQVosQ0FBbUJ3QixLQUFuQixDQUF5QjBELEdBQXpCO0FBQ0Q7QUFDRjs7QUFFRCxhQUFPdEMsTUFBUDtBQTNDd0I7QUE0Q3pCO0FBOU1ROztBQWlOWHVDLE9BQU9DLE9BQVAsR0FBaUIxRixJQUFqQiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgZXh0bmFtZSwgcmVzb2x2ZSB9ID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBzdHJpbmdpZnkgfSA9IHJlcXVpcmUoJ3FzJyk7XG5jb25zdCBCb29tID0gcmVxdWlyZSgnYm9vbScpO1xuY29uc3QgcyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUuc3RyaW5nJyk7XG5jb25zdCB7IGlzRW1wdHksIHNvcnRCeSwgZXZlcnksIGlzRnVuY3Rpb24gfSA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgeyBnZXRMYW5ndWFnZSB9ID0gcmVxdWlyZSgnY291bnRyeS1sYW5ndWFnZScpO1xuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XG5jb25zdCBpMThuID0gcmVxdWlyZSgnaTE4bicpO1xuY29uc3QgbG9jYWxlcyA9IHJlcXVpcmUoJ2kxOG4tbG9jYWxlcycpO1xuY29uc3QgYXV0b0JpbmQgPSByZXF1aXJlKCdhdXRvLWJpbmQnKTtcbmNvbnN0IGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnbGFkanM6aTE4bicpO1xuY29uc3QgYm9vbGVhbiA9IHJlcXVpcmUoJ2Jvb2xlYW4nKTtcblxuLy8gZXhwb3NlIGdsb2JhbFxuaTE4bi5hcGkgPSB7fTtcblxuY2xhc3MgSTE4TiB7XG4gIGNvbnN0cnVjdG9yKGNvbmZpZyA9IHt9KSB7XG4gICAgdGhpcy5jb25maWcgPSBPYmplY3QuYXNzaWduKFxuICAgICAge1xuICAgICAgICBwaHJhc2VzOiB7fSxcbiAgICAgICAgbG9nZ2VyOiBjb25zb2xlLFxuICAgICAgICBkaXJlY3Rvcnk6IHJlc29sdmUoJ2xvY2FsZXMnKSxcbiAgICAgICAgbG9jYWxlczogWydlbicsICdlcycsICd6aCddLFxuICAgICAgICBjb29raWU6ICdsb2NhbGUnLFxuICAgICAgICBpbmRlbnQ6ICcgICcsXG4gICAgICAgIGRlZmF1bHRMb2NhbGU6ICdlbicsXG4gICAgICAgIHN5bmNGaWxlczogYm9vbGVhbihwcm9jZXNzLmVudi5JMThOX1NZTkNfRklMRVMgfHwgdHJ1ZSksXG4gICAgICAgIGF1dG9SZWxvYWQ6IGJvb2xlYW4ocHJvY2Vzcy5lbnYuSTE4Tl9BVVRPX1JFTE9BRCB8fCBmYWxzZSksXG4gICAgICAgIHVwZGF0ZUZpbGVzOiBib29sZWFuKHByb2Nlc3MuZW52LkkxOE5fVVBEQVRFX0ZJTEVTIHx8IHRydWUpLFxuICAgICAgICBhcGk6IHtcbiAgICAgICAgICBfXzogJ3QnLFxuICAgICAgICAgIF9fbjogJ3RuJyxcbiAgICAgICAgICBfX2w6ICd0bCcsXG4gICAgICAgICAgX19oOiAndGgnLFxuICAgICAgICAgIF9fbWY6ICd0bWYnXG4gICAgICAgIH0sXG4gICAgICAgIHJlZ2lzdGVyOiBpMThuLmFwaVxuICAgICAgfSxcbiAgICAgIGNvbmZpZ1xuICAgICk7XG5cbiAgICBjb25zdCB7IGxvZ2dlciB9ID0gdGhpcy5jb25maWc7XG5cbiAgICB0aGlzLmNvbmZpZy5sb2dEZWJ1Z0ZuID0gbG9nZ2VyLmRlYnVnO1xuICAgIHRoaXMuY29uZmlnLmxvZ1dhcm5GbiA9IGxvZ2dlci53YXJuO1xuICAgIHRoaXMuY29uZmlnLmxvZ0Vycm9yRm4gPSBsb2dnZXIuZXJyb3I7XG5cbiAgICAvLyB2YWxpZGF0ZSBsb2NhbGVzIGFnYWluc3QgYXZhaWxhYmxlIG9uZXNcbiAgICBpZiAoIWV2ZXJ5KHRoaXMuY29uZmlnLmxvY2FsZXMsIGwgPT4gbG9jYWxlcy5pbmNsdWRlcyhsKSkpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBJbnZhbGlkIGxvY2FsZXM6ICR7dGhpcy5jb25maWcubG9jYWxlc1xuICAgICAgICAgIC5maWx0ZXIoc3RyID0+ICFsb2NhbGVzLmluY2x1ZGVzKHN0cikpXG4gICAgICAgICAgLmpvaW4oJywgJyl9YFxuICAgICAgKTtcblxuICAgIC8vIGluaGVyaXQgaTE4biBvYmplY3RcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIGkxOG4pO1xuXG4gICAgLy8gY29uZmlndXJlIGkxOG5cbiAgICB0aGlzLmNvbmZpZ3VyZSh0aGlzLmNvbmZpZyk7XG5cbiAgICBhdXRvQmluZCh0aGlzKTtcbiAgfVxuXG4gIHRyYW5zbGF0ZShrZXksIGxvY2FsZSkge1xuICAgIGNvbnN0IHsgbG9nZ2VyLCBwaHJhc2VzIH0gPSB0aGlzLmNvbmZpZztcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLXJlc3QtcGFyYW1zXG4gICAgbGV0IGFyZ3MgPSBPYmplY3Qua2V5cyhhcmd1bWVudHMpXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLXJlc3QtcGFyYW1zXG4gICAgICAubWFwKGtleSA9PiBhcmd1bWVudHNba2V5XSlcbiAgICAgIC5zbGljZSgyKTtcbiAgICBpZiAodHlwZW9mIGFyZ3MgPT09ICd1bmRlZmluZWQnKSBhcmdzID0gW107XG4gICAgY29uc3QgcGhyYXNlID0gcGhyYXNlc1trZXldO1xuICAgIGlmICh0eXBlb2YgcGhyYXNlICE9PSAnc3RyaW5nJykge1xuICAgICAgbG9nZ2VyLndhcm4oYHRyYW5zbGF0aW9uIGtleSBtaXNzaW5nOiAke2tleX1gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYXJncyA9IFt7IHBocmFzZSwgbG9jYWxlIH0sIC4uLmFyZ3NdO1xuICAgIHJldHVybiBpMThuLmFwaS50KC4uLmFyZ3MpO1xuICB9XG5cbiAgbWlkZGxld2FyZShjdHgsIG5leHQpIHtcbiAgICBjb25zdCB7IGxvY2FsZXMsIGRlZmF1bHRMb2NhbGUsIHBocmFzZXMsIGNvb2tpZSB9ID0gdGhpcy5jb25maWc7XG5cbiAgICAvLyBleHBvc2UgYXBpIG1ldGhvZHMgdG8gYGN0eC5yZXFgIGFuZCBgY3R4LnN0YXRlYFxuICAgIGkxOG4uaW5pdChjdHgucmVxLCBjdHguc3RhdGUpO1xuXG4gICAgLy8gZXhwb3NlIGEgaGVscGVyIGZ1bmN0aW9uIHRvIGBjdHguc3RhdGUubGBcbiAgICAvLyB3aGljaCBwcmVmaXhlcyBhIGxpbmsvcGF0aCB3aXRoIHRoZSBsb2NhbGVcbiAgICBjdHguc3RhdGUubCA9IChwYXRoID0gJycpID0+IHtcbiAgICAgIHJldHVybiBgLyR7Y3R4LnN0YXRlLmxvY2FsZX0ke3BhdGh9YDtcbiAgICB9O1xuXG4gICAgLy8gb3ZlcnJpZGUgdGhlIGV4aXN0aW5nIGxvY2FsZSBkZXRlY3Rpb24gd2l0aCBvdXIgb3duXG4gICAgLy8gaW4gb3JkZXIgb2YgcHJpb3JpdHk6XG4gICAgLy9cbiAgICAvLyAxLiBjaGVjayB0aGUgVVJMLCBpZiA9PT0gYC9kZWAgb3Igc3RhcnRzIHdpdGggYC9kZS9gIHRoZW4gbG9jYWxlIGlzIGBkZWBcbiAgICAvLyAyLiBjaGVjayB0aGUgY29va2llXG4gICAgLy8gMy4gY2hlY2sgQWNjZXB0LUxhbmd1YWdlIGxhc3RcbiAgICAvL1xuICAgIC8vIGFsc28gd2UgbmVlZCB0byBleHBvc2UgYGN0eC5wYXRoV2l0aG91dExvY2FsZWBcbiAgICAvLyBhcyB0aGUgcGF0aCB3aXRob3V0IGxvY2FsZVxuXG4gICAgbGV0IGxvY2FsZSA9IGxvY2FsZXMuZmluZChsID0+IHtcbiAgICAgIHJldHVybiBgLyR7bH1gID09PSBjdHgucGF0aCB8fCBjdHgucGF0aC5pbmRleE9mKGAvJHtsfS9gKSA9PT0gMDtcbiAgICB9KTtcblxuICAgIGN0eC5wYXRoV2l0aG91dExvY2FsZSA9IGxvY2FsZVxuICAgICAgPyBjdHgucGF0aC5zdWJzdHJpbmcoYC8ke2xvY2FsZX1gLmxlbmd0aClcbiAgICAgIDogY3R4LnBhdGg7XG4gICAgaWYgKGN0eC5wYXRoV2l0aG91dExvY2FsZSA9PT0gJycpIGN0eC5wYXRoV2l0aG91dExvY2FsZSA9ICcvJztcblxuICAgIGlmICghbG9jYWxlKSB7XG4gICAgICBsb2NhbGUgPSBkZWZhdWx0TG9jYWxlO1xuICAgICAgaWYgKFxuICAgICAgICBjdHguY29va2llcy5nZXQoY29va2llKSAmJlxuICAgICAgICBsb2NhbGVzLmluY2x1ZGVzKGN0eC5jb29raWVzLmdldChjb29raWUpKVxuICAgICAgKSB7XG4gICAgICAgIGxvY2FsZSA9IGN0eC5jb29raWVzLmdldChjb29raWUpO1xuICAgICAgICBkZWJ1ZygnZm91bmQgbG9jYWxlIHZpYSBjb29raWUgdXNpbmcgJXMnLCBsb2NhbGUpO1xuICAgICAgfSBlbHNlIGlmIChjdHgucmVxdWVzdC5hY2NlcHRzTGFuZ3VhZ2VzKGxvY2FsZXMpKSB7XG4gICAgICAgIGxvY2FsZSA9IGN0eC5yZXF1ZXN0LmFjY2VwdHNMYW5ndWFnZXMobG9jYWxlcyk7XG4gICAgICAgIGRlYnVnKCdmb3VuZCBsb2NhbGUgdmlhIEFjY2VwdC1MYW5ndWFnZSBoZWFkZXIgdXNpbmcgJXMnLCBsb2NhbGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGVidWcoJ3VzaW5nIGRlZmF1bHQgbG9jYWxlJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gc2V0IHRoZSBsb2NhbGUgcHJvcGVybHlcbiAgICBpMThuLnNldExvY2FsZShbY3R4LnJlcSwgY3R4LnN0YXRlXSwgbG9jYWxlKTtcbiAgICBjdHgubG9jYWxlID0gY3R4LnJlcS5sb2NhbGU7XG5cbiAgICAvLyBpZiB0aGUgbG9jYWxlIHdhcyBub3QgYXZhaWxhYmxlIHRoZW4gcmVkaXJlY3QgdXNlclxuICAgIGlmIChsb2NhbGUgIT09IGN0eC5zdGF0ZS5sb2NhbGUpIHtcbiAgICAgIGRlYnVnKCdsb2NhbGUgd2FzIG5vdCBhdmFpbGFibGUgcmVkaXJlY3RpbmcgdXNlcicpO1xuICAgICAgcmV0dXJuIGN0eC5yZWRpcmVjdChcbiAgICAgICAgYC8ke2N0eC5zdGF0ZS5sb2NhbGV9JHtjdHgucGF0aFdpdGhvdXRMb2NhbGV9JHtcbiAgICAgICAgICBpc0VtcHR5KGN0eC5xdWVyeSkgPyAnJyA6IGA/JHtzdHJpbmdpZnkoY3R4LnF1ZXJ5KX1gXG4gICAgICAgIH1gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGF2YWlsYWJsZSBsYW5ndWFnZXMgZm9yIGEgZHJvcGRvd24gbWVudSB0byBjaGFuZ2UgbGFuZ3VhZ2VcbiAgICBjdHguc3RhdGUuYXZhaWxhYmxlTGFuZ3VhZ2VzID0gc29ydEJ5KFxuICAgICAgbG9jYWxlcy5tYXAobG9jYWxlID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBsb2NhbGUsXG4gICAgICAgICAgdXJsOiBgLyR7bG9jYWxlfSR7Y3R4LnBhdGhXaXRob3V0TG9jYWxlfSR7XG4gICAgICAgICAgICBpc0VtcHR5KGN0eC5xdWVyeSkgPyAnJyA6IGA/JHtzdHJpbmdpZnkoY3R4LnF1ZXJ5KX1gXG4gICAgICAgICAgfWAsXG4gICAgICAgICAgbmFtZTogZ2V0TGFuZ3VhZ2UobG9jYWxlKS5uYW1lWzBdXG4gICAgICAgIH07XG4gICAgICB9KSxcbiAgICAgICduYW1lJ1xuICAgICk7XG5cbiAgICAvLyBnZXQgdGhlIG5hbWUgb2YgdGhlIGN1cnJlbnQgbG9jYWxlJ3MgbGFuZ3VhZ2UgaW4gbmF0aXZlIGxhbmd1YWdlXG4gICAgY3R4LnN0YXRlLmN1cnJlbnRMYW5ndWFnZSA9IHMudGl0bGVpemUoXG4gICAgICBnZXRMYW5ndWFnZShjdHgucmVxLmxvY2FsZSkubmF0aXZlTmFtZVswXVxuICAgICk7XG5cbiAgICAvLyBiaW5kIGBjdHgudHJhbnNsYXRlYCBhcyBhIGhlbHBlciBmdW5jXG4gICAgLy8gc28geW91IGNhbiBwYXNzIGBjdHgudHJhbnNsYXRlKCdTT01FX0tFWV9JTl9DT05GSUcnKTtgIGFuZCBpdCB3aWxsIGxvb2t1cFxuICAgIC8vIGBwaHJhc2VzWydTT01FVEhJTkcnXWAgdG8gZ2V0IGEgc3BlY2lmaWMgYW5kIGNvbnN0YW50IG1lc3NhZ2VcbiAgICAvLyBhbmQgdGhlbiBpdCB3aWxsIGNhbGwgYHRgIHRvIHRyYW5zbGF0ZSBpdCB0byB0aGUgdXNlcidzIGxvY2FsZVxuICAgIGN0eC50cmFuc2xhdGUgPSBmdW5jdGlvbiguLi5hcmdzKSB7XG4gICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gIT09ICdzdHJpbmcnIHx8IHR5cGVvZiBwaHJhc2VzW2FyZ3NbMF1dICE9PSAnc3RyaW5nJylcbiAgICAgICAgcmV0dXJuIGN0eC50aHJvdyhcbiAgICAgICAgICBCb29tLmJhZFJlcXVlc3QoJ1RyYW5zbGF0aW9uIGZvciB5b3VyIGxvY2FsZSBmYWlsZWQsIHRyeSBhZ2FpbicpXG4gICAgICAgICk7XG4gICAgICBhcmdzWzBdID0gcGhyYXNlc1thcmdzWzBdXTtcbiAgICAgIHJldHVybiBjdHgucmVxLnQoLi4uYXJncyk7XG4gICAgfTtcblxuICAgIHJldHVybiBuZXh0KCk7XG4gIH1cblxuICBhc3luYyByZWRpcmVjdChjdHgsIG5leHQpIHtcbiAgICBkZWJ1ZygnYXR0ZW1wdGluZyB0byByZWRpcmVjdCcpO1xuICAgIC8vIGRvIG5vdCByZWRpcmVjdCBzdGF0aWMgcGF0aHNcbiAgICBpZiAoZXh0bmFtZShjdHgucGF0aCkgIT09ICcnKSByZXR1cm4gbmV4dCgpO1xuXG4gICAgLy8gaW5zcGlyZWQgYnkgbm9kZWpzLm9yZyBsYW5ndWFnZSBzdXBwb3J0XG4gICAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZWpzLm9yZy9jb21taXQvZDZjZGQ5NDJhOGZjMGZmZmNmNjg3OWVjYTEyNDI5NWU5NTk5MWJiYyNkaWZmLTc4YzEyZjVhZGMxODQ4ZDEzYjFjNmYwNzA1NWQ5OTZlUjU5PlxuICAgIGNvbnN0IGxvY2FsZSA9IGN0eC51cmwuc3BsaXQoJy8nKVsxXS5zcGxpdCgnPycpWzBdO1xuICAgIGNvbnN0IGhhc0xhbmcgPSB0aGlzLmNvbmZpZy5sb2NhbGVzLmluY2x1ZGVzKGxvY2FsZSk7XG5cbiAgICAvLyBpZiB0aGUgVVJMIGRpZCBub3QgaGF2ZSBhIHZhbGlkIGxhbmd1YWdlIGZvdW5kXG4gICAgLy8gdGhlbiByZWRpcmVjdCB0aGUgdXNlciB0byB0aGVpciBkZXRlY3RlZCBsb2NhbGVcbiAgICBpZiAoIWhhc0xhbmcpIHtcbiAgICAgIGN0eC5zdGF0dXMgPSAzMDI7XG4gICAgICBsZXQgcmVkaXJlY3QgPSBgLyR7Y3R4LnJlcS5sb2NhbGV9JHtjdHgudXJsfWA7XG4gICAgICBpZiAoIWlzRW1wdHkoY3R4LnF1ZXJ5KSkgcmVkaXJlY3QgKz0gYD8ke3N0cmluZ2lmeShjdHgucXVlcnkpfWA7XG4gICAgICBkZWJ1Zygnbm8gdmFsaWQgbG9jYWxlIGZvdW5kIGluIFVSTCwgcmVkaXJlY3RpbmcgdG8gJXMnLCByZWRpcmVjdCk7XG4gICAgICByZXR1cm4gY3R4LnJlZGlyZWN0KHJlZGlyZWN0KTtcbiAgICB9XG5cbiAgICBkZWJ1ZygnZm91bmQgdmFsaWQgbGFuZ3VhZ2UgXCIlc1wiJywgbG9jYWxlKTtcblxuICAgIC8vIHNldCB0aGUgY29va2llIGZvciBmdXR1cmUgcmVxdWVzdHNcbiAgICBjdHguY29va2llcy5zZXQodGhpcy5jb25maWcuY29va2llLCBsb2NhbGUsIHtcbiAgICAgIC8vIERpc2FibGUgc2lnbmVkIGNvb2tpZXMgaW4gTk9ERV9FTlY9dGVzdFxuICAgICAgc2lnbmVkOiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Rlc3QnLFxuICAgICAgZXhwaXJlczogbW9tZW50KClcbiAgICAgICAgLmFkZCgxLCAneWVhcicpXG4gICAgICAgIC50b0RhdGUoKVxuICAgIH0pO1xuICAgIGRlYnVnKCdzZXQgY29va2llcyBmb3IgbG9jYWxlIFwiJXNcIicsIGxvY2FsZSk7XG5cbiAgICAvLyBpZiB0aGUgdXNlciBpcyBsb2dnZWQgaW4gYW5kIGN0eC5pc0F1dGhlbnRpY2F0ZWQoKSBleGlzdHMsXG4gICAgLy8gdGhlbiBzYXZlIGl0IGFzIGBsYXN0X2xvY2FsZWBcbiAgICBpZiAoaXNGdW5jdGlvbihjdHguaXNBdXRoZW50aWNhdGVkKSAmJiBjdHguaXNBdXRoZW50aWNhdGVkKCkpIHtcbiAgICAgIGN0eC5zdGF0ZS51c2VyLmxhc3RfbG9jYWxlID0gbG9jYWxlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgY3R4LnN0YXRlLnVzZXIuc2F2ZSgpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMuY29uZmlnLmxvZ2dlci5lcnJvcihlcnIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXh0KCk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBJMThOO1xuIl19